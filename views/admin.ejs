<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Panel Admina</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; margin: 0; padding: 20px; }
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    h1 { margin: 0; color: #333; }
    .user { color: #666; margin-top: 5px; }
    button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-logout { background: #f44336; color: white; }
    .btn-refresh { background: #2196F3; color: white; }
    .btn-excel { background: #4CAF50; color: white; }
    .btn-reset { background: #FF9800; color: white; }
    button:hover { opacity: 0.9; }
    
    .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .filters h3 { margin-top: 0; color: #333; }
    .filter-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .filter-btn { 
      padding: 15px; 
      background: #f5f5f5; 
      color: #333; 
      border: 2px solid #e0e0e0; 
      border-radius: 10px; 
      font-size: 1rem; 
      cursor: pointer; 
      transition: all 0.3s;
    }
    .filter-btn:hover { 
      background: #e8e8e8; 
      transform: translateY(-2px); 
    }
    .filter-btn.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border-color: #667eea;
      transform: translateY(0);
    }
    
    .card { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; }
    .card h2 { color: #4CAF50; margin-top: 0; text-transform: capitalize; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; }
    .stat .emoji { font-size: 40px; }
    .stat .value { font-size: 2rem; font-weight: bold; color: #333; }
    .stat .label { color: #666; font-size: 14px; }
    .daily { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .daily h3 { margin-top: 0; color: #666; }
    .daily-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
    .daily-item { background: white; padding: 10px; border-radius: 5px; text-align: center; }
    .daily-item .label { color: #666; font-size: 14px; }
    .daily-item .value { font-size: 1.5rem; font-weight: bold; color: #4CAF50; }
    .comments { background: #f9f9f9; padding: 15px; border-radius: 8px; }
    .comments h3 { margin-top: 0; color: #666; }
    .comment { background: white; padding: 12px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #4CAF50; }
    .comment.neutral { border-left-color: #FFC107; }
    .comment.sad { border-left-color: #f44336; }
    .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #666; }
    .comment-rating { font-weight: bold; }
    .comment-date { font-size: 12px; }
    .comment-text { color: #333; }
    .no-comments { text-align: center; color: #999; padding: 20px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div>
        <h1>üìä Panel Administracyjny</h1>
        <div class="user" id="userName"></div>
      </div>
      <div class="header-buttons">
        <button class="btn-refresh" onclick="loadStats()">üîÑ Od≈õwie≈º</button>
        <button class="btn-excel" onclick="exportExcel()">üìä Export Excel</button>
        <button class="btn-reset" id="btnReset" onclick="resetData()" style="display:none">‚ö†Ô∏è Reset danych</button>
        <button class="btn-logout" onclick="logout()">Wyloguj</button>
      </div>
    </div>
  </div>
  
  <div class="filters" id="filterSection">
    <h3>üîç Filtruj lokalizacjƒô:</h3>
    <div class="filter-buttons">
      <button class="filter-btn active" onclick="filterLocation('all')">üìä Wszystkie</button>
      <button class="filter-btn" onclick="filterLocation('ruda')">üìç Ruda ≈ölƒÖska</button>
      <button class="filter-btn" onclick="filterLocation('siedlce')">üìç Siedlce</button>
      <button class="filter-btn" onclick="filterLocation('emilianow')">üìç Emilian√≥w</button>
    </div>
  </div>
  
  <div id="statsContainer"></div>
  
  <script>
    const user = JSON.parse(sessionStorage.getItem('user') || '{}');
    let currentFilter = 'all';
    let allData = [];
    
    if (!user.role) {
      location.href = '/admin/login';
    }
    
    document.getElementById('userName').textContent = user.name + ' (' + user.email + ')';
    
    if (user.role === 'admin') {
      document.getElementById('btnReset').style.display = 'block';
    }
    
    // Ukryj filtry dla kierownik√≥w (widzƒÖ tylko swojƒÖ lokalizacjƒô)
    if (user.role === 'manager') {
      document.getElementById('filterSection').style.display = 'none';
    }
    
    function filterLocation(loc) {
      currentFilter = loc;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Filter and display data
      displayFilteredData();
    }
    
    function displayFilteredData() {
      let filteredData = allData;
      
      if (currentFilter !== 'all') {
        filteredData = allData.filter(loc => loc.location === currentFilter);
      }
      
      renderStats(filteredData);
    }
    
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
    
    function getRatingText(rating) {
      if (rating === 'happy') return 'üòä Bardzo dobrze';
      if (rating === 'neutral') return 'üòê W porzƒÖdku';
      if (rating === 'sad') return '‚òπÔ∏è ≈πle';
      return rating;
    }
    
    function loadStats() {
      fetch(`/admin/stats?location=${user.location}&role=${user.role}`)
        .then(r => r.json())
        .then(data => {
          allData = data;
          displayFilteredData();
        });
    }
    
    function renderStats(data) {
      let html = '';
      
      if (data.length === 0) {
        html = '<div class="card"><p>Brak danych</p></div>';
      } else {
        data.forEach(loc => {
          const total = loc.total || 0;
          const happyPct = total > 0 ? ((loc.happy / total) * 100).toFixed(1) : 0;
          const neutralPct = total > 0 ? ((loc.neutral / total) * 100).toFixed(1) : 0;
          const sadPct = total > 0 ? ((loc.sad / total) * 100).toFixed(1) : 0;
          
          html += `
            <div class="card">
              <h2>${loc.location}</h2>
              <div class="stats">
                <div class="stat">
                  <div class="emoji">üòä</div>
                  <div class="value">${loc.happy}</div>
                  <div class="label">Bardzo dobrze (${happyPct}%)</div>
                </div>
                <div class="stat">
                  <div class="emoji">üòê</div>
                  <div class="value">${loc.neutral}</div>
                  <div class="label">W porzƒÖdku (${neutralPct}%)</div>
                </div>
                <div class="stat">
                  <div class="emoji">‚òπÔ∏è</div>
                  <div class="value">${loc.sad}</div>
                  <div class="label">≈πle (${sadPct}%)</div>
                </div>
              </div>
              <div class="daily">
                <h3>Statystyki dzienne:</h3>
                <div class="daily-stats">
                  <div class="daily-item">
                    <div class="label">Razem</div>
                    <div class="value">${total}</div>
                  </div>
                  <div class="daily-item">
                    <div class="label">Dzisiaj</div>
                    <div class="value">${loc.today}</div>
                  </div>
                  <div class="daily-item">
                    <div class="label">Wczoraj</div>
                    <div class="value">${loc.yesterday}</div>
                  </div>
                </div>
              </div>
              <div class="comments">
                <h3>Komentarze:</h3>
                <div id="comments-${loc.location}"></div>
              </div>
            </div>
          `;
        });
      }
      
      document.getElementById('statsContainer').innerHTML = html;
      
      data.forEach(loc => {
        loadComments(loc.location);
      });
    }
    
    function loadComments(location) {
      fetch(`/admin/comments?location=${location}`)
        .then(r => r.json())
        .then(comments => {
          let html = '';
          
          if (comments.length === 0) {
            html = '<div class="no-comments">Brak komentarzy</div>';
          } else {
            comments.forEach(c => {
              if (c.comment && c.comment.trim()) {
                html += `
                  <div class="comment ${c.rating}">
                    <div class="comment-header">
                      <span class="comment-rating">${getRatingText(c.rating)}</span>
                      <span class="comment-date">${formatDate(c.created_at)}</span>
                    </div>
                    <div class="comment-text">${c.comment}</div>
                  </div>
                `;
              }
            });
            
            if (!html) {
              html = '<div class="no-comments">Brak komentarzy</div>';
            }
          }
          
          document.getElementById('comments-' + location).innerHTML = html;
        });
    }
    
    function exportExcel() {
      const exportLoc = currentFilter === 'all' ? user.location : currentFilter;
      window.location.href = `/admin/export?location=${exportLoc}&role=${user.role}`;
    }
    
    function resetData() {
      if (!confirm('‚ö†Ô∏è UWAGA! To usunie WSZYSTKIE dane ze wszystkich lokalizacji!\n\nCzy na pewno chcesz kontynuowaƒá?')) {
        return;
      }
      
      if (!confirm('To jest OSTATNIE OSTRZE≈ªENIE!\n\nWszystkie opinie zostanƒÖ bezpowrotnie usuniƒôte!\n\nKontynuowaƒá?')) {
        return;
      }
      
      fetch('/admin/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: user.role })
      })
      .then(r => r.json())
      .then(d => {
        if (d.ok) {
          alert('‚úÖ Wszystkie dane zosta≈Çy usuniƒôte!');
          loadStats();
        } else {
          alert('‚ùå B≈ÇƒÖd: ' + (d.msg || 'Nie uda≈Ço siƒô usunƒÖƒá danych'));
        }
      });
    }
    
    function logout() {
      sessionStorage.removeItem('user');
      location.href = '/admin/login';
    }
    
    loadStats();
  </script>
</body>
</html>
